---
method: post
---
{% liquid
    function current_profile = 'modules/user/helpers/current_profile'
    if current_profile.user == null
        redirect_to "/"
    endif

    assign total = 0
    for item in params.line_items
        assign line_price = item.price_data.unit_amount | times: item.quantity
        assign total = total | plus: line_price
    endfor

    assign ids = '["1", "2"]' | parse_json
    assign object = null | hash_merge: gateway: 'stripe', payable_ids: ids, amount_cents: total, currency: 'USD', payer_id: current_profile.id
    function object = 'modules/payments/commands/transactions/create', object: object

    assign success_url = 'https://' | append: context.location.host | append: '/success/' | append: object.id
    assign failed_url = 'https://' | append: context.location.host | append: '/cancel/' | append: object.id
    assign stripe_params = null | hash_merge: success_url: success_url, cancel_url: failed_url, line_items: params.line_items
    function url = 'modules/payments/helpers/pay_url', transaction: object, gateway_params: stripe_params

    redirect_to url, status: 303
%}